<!doctype html>
<html lang=en>

<head>
  <meta charset=utf-8>
  <title>blah</title>

  <style>
    body {
      font-size: 24px;
    }

    h2 {
      height: 2rem;
      font-size: 2rem;
      margin-block-start: 0;
      margin-block-end: 0;
      margin: 0 0 1rem 0;
    }

    .invisible {
      visibility: hidden;
    }

    .previous {
      transform: translateY(3rem);
      animation-name: move-up;
      animation-duration: 0.3s;
      animation-timing-function: ease-in-out;
      animation-iteration-count: 1;
      animation-fill-mode: forwards;
      z-index: -1;
    }

    @keyframes move-up {
      from {
        transform: translateY(3rem);
        opacity: 100%;
      }

      to {
        transform: translateY(0rem);
        opacity: 60%;
      }
    }
  </style>
</head>

<body>

  <template id=start>
    <button autofocus onclick="startGame()">LEGO NINJA!!!!! ü•∑üî•</button>
  </template>

  <template id=test>
    <div id=previous-result>&npsp;</div>

    <h2 class=previous>
      <span class=previousleft></span>
      <span class=previousoperation></span>
      <span class=previousright></span>
      = <span class=previousanswer></span>
    </h2>

    <h2>
      <span class=left></span>
      <span class=operation></span>
      <span class=right></span>
      = ???
    </h2>

    <form>
      <input type=number name=answer autofocus />
    </form>

  </template>

  <template id=done>
    <h1>YOU DID IT!</h1>

    <p>You're all done. You got <span class=correct></span> correct out of <span class=count></span> questions</p>
  </template>

  <div id=game></div>

  <script>
    var state = {};
    window.state = state;

    // state = {
    //   problems: [
    //     { left: 3, right: 8, operation: '+', answer: 11 },
    //     { left: 8, right: 4, operation: '-' },
    //     { left: 8, right: 9, operation: '+' },
    //   ],
    // }

    const operations = ['+', '-'];

    function getCorrectAnswer(problem) {
      if (problem.operation == '+') {
        return problem.left + problem.right;
      } else if (problem.operation == '-') {
        return problem.left - problem.right;
      }
    }

    function isCorrect(problem) {
      return getCorrectAnswer(problem) == problem.answer;
    }

    function startGame() {
      console.log('starting game');
      state.problems = Array.apply(null, Array(10)).map(function () {
        const problem = {
          left: Math.floor(Math.random() * 10),
          right: Math.floor(Math.random() * 10),
          operation: operations[Math.floor(Math.random() * operations.length)],
        }
        if (problem.operation == '-' && problem.left < problem.right) {
          const temp = problem.left;
          problem.left = problem.right;
          problem.right = temp;
        }
        return problem;
      });

      render();
    }

    function getAnswer(event) {
      console.log('getting answer');
      event.preventDefault();
      const input = parseInt(document.querySelector('[name=answer]').value, 10);
      const currentProblem = state.problems.find((value, index) => {
        return !value.answer;
      });
      currentProblem.answer = input;

      if (isCorrect(currentProblem)) {
        console.log('you did it');
      } else {
        console.log(`Not quite, ${currentProblem.left} + ${currentProblem.right} does not equal ${input}`);
      }

      render();
    }

    function render() {
      const game = document.getElementById('game');

      if (!state.problems) {
        const startTemplate = document.getElementById('start');
        game.innerHTML = startTemplate.innerHTML;
      } else if (state.problems.every(p => p.answer != null)) {
        const doneTemplate = document.getElementById('done');
        game.innerHTML = doneTemplate.innerHTML;

        game.querySelector('.correct').textContent = state.problems.filter(isCorrect).length;
        game.querySelector('.count').textContent = state.problems.length;
      } else {
        const gameTemplate = document.getElementById('test');

        const currentProblem = state.problems.find((value, index) => {
          return !value.answer;
        });

        const previousProblem = state.problems.slice().reverse().find((value) => {
          return !!value.answer
        });

        game.innerHTML = gameTemplate.innerHTML;

        if (previousProblem) {
          game.querySelector('.previousleft').textContent = previousProblem.left;
          game.querySelector('.previousright').textContent = previousProblem.right;
          game.querySelector('.previousoperation').textContent = previousProblem.operation;
          game.querySelector('.previousanswer').textContent = previousProblem.answer;

          if (isCorrect(previousProblem)) {
            game.querySelector('.previous').style = 'color: green';
          } else {
            game.querySelector('.previous').style = 'color: red';
          }
        } else {
          game.querySelector('.previous').classList.add('invisible');
        }

        document.querySelector('form').onsubmit = getAnswer;
        document.querySelector('.left').textContent = currentProblem.left;
        document.querySelector('.operation').textContent = currentProblem.operation;
        document.querySelector('.right').textContent = currentProblem.right;

        if (previousProblem) {
          if (isCorrect(previousProblem)) {
            document.querySelector('#previous-result').textContent = 'ü•∑ you got it way to go! ü•∑';
            // new Audio('/audio/gadeej.mp3').play();
            new Audio('/audio/anderson-singing-sugar-were-going-down.m4a').play();
          } else {
            document.querySelector('#previous-result').textContent =
                `‚õîÔ∏è Not quite, ${previousProblem.left} ${previousProblem.operation} ${previousProblem.right} does not equal ${previousProblem.answer}Ô∏èÔ∏è ‚õîÔ∏è`;
            new Audio('/audio/fart.mp3').play();
          }
        } else {
          document.querySelector('#previous-result').classList.add('invisible');
        }

        document.querySelector('input').focus()
      }
    }

    render();
  </script>

</body>

</html>